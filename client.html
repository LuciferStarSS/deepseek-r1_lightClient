<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1,user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-title" content="chatbox">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="chatbox">
    <title>DeepSeek 轻客户端</title>

<style>

.chat{
    background: gray;
    position: relative;
    margin: 10 10 10 10;
}
.chat_deleted
{
    background: black;
    position: relative;
    margin: 10 10 10 10;
  
}


.chat .abort{
    position: relative;
    display: block;
    margin: auto auto 10 auto;
}

.chat .remove{
    position: relative;
    display: none;
    margin: auto auto 10 auto;
}

.chat .remove_reply{
    position: relative;
    display: none;
    margin: auto auto 10 auto;
}

.ask{
    background: beige;
    position: relative;
    margin: 0px 10px 10px 50px;
    top:10px
}

.ask_deleted{
    background: black;
    position: relative;
    margin: 0px 10px 10px 50px;
    top:10px
}

.ask .user{
    color: blue;
    text-align: right;
    background: gainsboro;
}

.ask .text{
    color: crimson;
    padding: 20px;
    background: aquamarine;
}

.reply{
    position: relative;
    margin:10 50 10 10;
    background: antiquewhite;
    top:10px
}

.reply_deleted{
    position: relative;
    margin:10 50 10 10;
    background: black;
    top:10px
}

.reply .user{
    color: blue;
    background: gainsboro;
    width: 24px;
}

.reply .text{
    color: crimson;
    padding: 20px;
    background: aquamarine;
}

.info{
    position: relative;
    margin:20 10 10 10;
    background: black;
    color: yellow;
    font-size: 14px;
}

.operation{
    display: flex;
}

.role{
    position: relative;
    background: blue;
    color: yellow;
    font-size: 14px;
    text-align: center;
    height: 20px;
}

</style>

  <script>

   var dsServer		= null;		//DeepSeek服务器地址
   var dsModel		= null;		//DeepSeek模型
   var dsRole		= null;		//会话角色  system：设定场景、角色   user：用户会话查询   assitant：服务器反馈
   var dsTemperature	= 0.0;		//按使用场景设置。代码生成/数学解题：0.0；数据抽取/分析：1.0；通用对话：1.3；翻译：1.3；创意类写作/诗歌创作：1.5。
   var dsChatAPI	= "/api/chat";	//对话查询接口
   var dsTagsAPI	= "/api/tags";	//获取Model接口

   var divMsg 		= null;  	//对话消息窗口
   var modelSelector	= null;		//模型下拉选择控件
   var msgInput		= null;		//用户查询数据输入

   var chatID = 0;
   var arrChatMessages 	  = new Array();	//历史请求数据
   var arrChatDivs        = new Array();	//DeepSeek返回内容所在窗口句柄
   var arrChatResponse    = new Array();	//有效返回值
   var arrAbortController = new Array();	//终止控制

   const headers = new Headers();   		//查询操作的数据头，请求返回json数据
   headers.append('Content-Type', 'application/json');

   var jsonData={   				//访问接口/api/chat时需要的数据格式
      "model": '',				//模型
      "messages": [],				//往来消息
      "stream": true,				//数据流的方式返回数据
      "options": {
         "temperature": 0.0			//浮点数。多样性控制
      }
   };

   //新建会话
   function newChat(){
      arrChatMessages.length	= 0;
      arrChatResponse.length	= 0;
      arrChatDivs.length	= 0;
      arrAbortController.length	= 0;
      msgInput.value 		= '';
      divMsg.innerHTML		= '';
   }

   //获取DeepSeek服务器上所有的Model
   async function getModel(o) {
      modelSelector.length	= 0;

      if(o.value){
         const response = await fetch('http://'+o.value+':11434'+dsTagsAPI, {
            method: 'GET',
            headers: headers,
            cache: 'no-store'
         })
         .then(response => {
            if(!response.ok){ throw new Error("Network response was not ok.");}
            return response.json();
         })
         .then(data => {            							//解析得到的Model信息
            for(var i=0;i<data.models.length;i++){
               modelSelector.options.add(new Option(data.models[i].name,data.models[i].model));
            }
         })
         .catch(error => {
            //console.error("Fetch error:",error);
         });
      }
   }

   //提交人机会话数据
   //为保证能让DeepSeek实现上下文关联，发送时，会把当前会话的所有内容都发送到服务器，
   //具体操作在buildMsg()里。
   function sendQuery() {
      if(dsServer.value && dsModel.value && msgInput.value){
         chatID	+= 2;									//对话记录计数器，用于终止接收控制，以及往来信息的增删
         var nChatID = chatID;

         let controller	= new AbortController();					//终止接收控制
         arrAbortController[chatID] = controller;

         var divChat = document.createElement("DIV");
         divChat.id = "ROLE_"+chatID;							//某一轮问答可以通过这个ID进行删除操作
         divChat.className = "chat";

         var divRole = document.createElement("DIV");					//删除记录按钮
         divRole.className="role";
         //divRole.style = "position: relative;height: 1px;display: block;";
         divRole.innerText = dsServer.value +' - '+ (dsRole.value=="system"?"设置对话的背景或上下文":"向助手提出的问题或请求") +' - 随机性/多样性参数：'+ dsTemperature.value;

         divChat.appendChild(divRole);

         var divMe = document.createElement("DIV");	         			//提问数据的显示
         divMe.className = "ask";
         var divUser  =document.createElement("DIV");
         divUser.className  ="user";
         var date = new Date();
         divUser.innerHTML='<svg   title='+ date.toLocaleString() +' width="24" height="24" xmlns="http://www.w3.org/2000/svg"><g><rect fill="#fff" id="canvas_background" height="26" width="26" y="-1" x="-1"/><g display="none" overflow="visible" y="0" x="0" height="100%" width="100%" id="canvasGrid"><rect fill="url(#gridpattern)" stroke-width="0" y="0" x="0" height="100%" width="100%"/></g></g><g><path stroke="#f00" id="svg_1" d="m12.092575,0.656102c-6.040896,0 -10.937497,4.990165 -10.937497,11.145835c0,6.155987 4.896602,11.14583 10.937497,11.14583c6.040613,0 10.937501,-4.989843 10.937501,-11.14583c0,-6.155671 -4.896887,-11.145835 -10.937501,-11.145835zm0.999318,17.565384l-2.037093,0l0,-1.990741l2.037093,0l0,1.990741zm0,-4.116353l0,0.657924l-2.037093,0l0,-0.810649c0,-2.446224 2.731785,-2.834416 2.731785,-4.573033c0,-0.792774 -0.695571,-1.400061 -1.606181,-1.400061c-0.94361,0 -1.771235,0.70852 -1.771235,0.70852l-1.159776,-1.46857c0,0 1.143131,-1.214911 3.1133,-1.214911c1.871461,0 3.609109,1.180985 3.609109,3.172018c0.000873,2.785292 -2.879909,3.106502 -2.879909,4.928762l0,0.000001z" fill="#fff"/></g></svg>';
         //divUser.innerText = "我（" + date.toLocaleString() + "）";
         divMe.appendChild(divUser);
         var divText = document.createElement("DIV");
         divText.className = "text";
         divText.innerText = msgInput.value;
         divMe.appendChild(divText);
         divChat.appendChild(divMe);

         var divReply = document.createElement("DIV");         				//回答数据的显示
         divReply.className = "reply";
         var divUser = document.createElement("DIV");
         divUser.className = "user";
         divUser.innerHTML='<svg viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path id="path" d="M27.501 8.46875C27.249 8.3457 27.1406 8.58008 26.9932 8.69922C26.9434 8.73828 26.9004 8.78906 26.8584 8.83398C26.4902 9.22852 26.0605 9.48633 25.5 9.45508C24.6787 9.41016 23.9785 9.66797 23.3594 10.2969C23.2275 9.52148 22.79 9.05859 22.125 8.76172C21.7764 8.60742 21.4238 8.45312 21.1807 8.11719C21.0098 7.87891 20.9639 7.61328 20.8779 7.35156C20.8242 7.19336 20.7695 7.03125 20.5879 7.00391C20.3906 6.97266 20.3135 7.13867 20.2363 7.27734C19.9258 7.84375 19.8066 8.46875 19.8174 9.10156C19.8447 10.5234 20.4453 11.6562 21.6367 12.4629C21.7725 12.5547 21.8076 12.6484 21.7646 12.7832C21.6836 13.0605 21.5869 13.3301 21.501 13.6074C21.4473 13.7852 21.3662 13.8242 21.1768 13.7461C20.5225 13.4727 19.957 13.0684 19.458 12.5781C18.6104 11.7578 17.8438 10.8516 16.8877 10.1426C16.6631 9.97656 16.4395 9.82227 16.207 9.67578C15.2314 8.72656 16.335 7.94727 16.5898 7.85547C16.8574 7.75977 16.6826 7.42773 15.8193 7.43164C14.957 7.43555 14.167 7.72461 13.1611 8.10938C13.0137 8.16797 12.8594 8.21094 12.7002 8.24414C11.7871 8.07227 10.8389 8.0332 9.84766 8.14453C7.98242 8.35352 6.49219 9.23633 5.39648 10.7441C4.08105 12.5547 3.77148 14.6133 4.15039 16.7617C4.54883 19.0234 5.70215 20.8984 7.47559 22.3633C9.31348 23.8809 11.4307 24.625 13.8457 24.4824C15.3125 24.3984 16.9463 24.2012 18.7881 22.6406C19.2529 22.8711 19.7402 22.9629 20.5498 23.0332C21.1729 23.0918 21.7725 23.002 22.2373 22.9062C22.9648 22.752 22.9141 22.0781 22.6514 21.9531C20.5186 20.959 20.9863 21.3633 20.5605 21.0371C21.6445 19.752 23.2783 18.418 23.917 14.0977C23.9668 13.7539 23.9238 13.5391 23.917 13.2598C23.9131 13.0918 23.9512 13.0254 24.1445 13.0059C24.6787 12.9453 25.1973 12.7988 25.6738 12.5352C27.0557 11.7793 27.6123 10.5391 27.7441 9.05078C27.7637 8.82422 27.7402 8.58789 27.501 8.46875ZM15.46 21.8613C13.3926 20.2344 12.3906 19.6992 11.9766 19.7227C11.5898 19.7441 11.6592 20.1875 11.7441 20.4766C11.833 20.7617 11.9492 20.959 12.1123 21.209C12.2246 21.375 12.3018 21.623 12 21.8066C11.334 22.2207 10.1768 21.668 10.1221 21.6406C8.77539 20.8477 7.64941 19.7988 6.85547 18.3652C6.08984 16.9844 5.64453 15.5039 5.57129 13.9238C5.55176 13.541 5.66406 13.4062 6.04297 13.3379C6.54199 13.2461 7.05762 13.2266 7.55664 13.2988C9.66602 13.6074 11.4619 14.5527 12.9668 16.0469C13.8262 16.9004 14.4766 17.918 15.1465 18.9121C15.8584 19.9688 16.625 20.9746 17.6006 21.7988C17.9443 22.0879 18.2197 22.3086 18.4824 22.4707C17.6895 22.5586 16.3652 22.5781 15.46 21.8613ZM16.4502 15.4805C16.4502 15.3105 16.5859 15.1758 16.7568 15.1758C16.7949 15.1758 16.8301 15.1836 16.8613 15.1953C16.9033 15.2109 16.9424 15.2344 16.9727 15.2695C17.0273 15.3223 17.0586 15.4004 17.0586 15.4805C17.0586 15.6504 16.9229 15.7852 16.7529 15.7852C16.582 15.7852 16.4502 15.6504 16.4502 15.4805ZM19.5273 17.0625C19.3301 17.1426 19.1328 17.2129 18.9434 17.2207C18.6494 17.2344 18.3281 17.1152 18.1533 16.9688C17.8828 16.7422 17.6895 16.6152 17.6074 16.2168C17.5732 16.0469 17.5928 15.7852 17.623 15.6348C17.6934 15.3105 17.6152 15.1035 17.3877 14.9141C17.2012 14.7598 16.9658 14.7188 16.7061 14.7188C16.6094 14.7188 16.5205 14.6758 16.4541 14.6406C16.3457 14.5859 16.2568 14.4512 16.3418 14.2852C16.3691 14.2324 16.501 14.1016 16.5322 14.0781C16.8838 13.877 17.29 13.9434 17.666 14.0938C18.0146 14.2363 18.2773 14.498 18.6562 14.8672C19.0439 15.3145 19.1133 15.4395 19.334 15.7734C19.5078 16.0371 19.667 16.3066 19.7754 16.6152C19.8408 16.8066 19.7559 16.9648 19.5273 17.0625Z" fill-rule="nonzero" fill="#4D6BFE"></path></svg>';

         //var date = new Date();
         //divUser.innerText = "DeepSeek";
         divReply.appendChild(divUser);
         var divText = document.createElement("DIV");
         divText.className = "text";
         divText.id = chatID;								//数据接收后，通过chatID实现数据精准显示
         divReply.appendChild(divText);
         divChat.appendChild(divReply);

         var divInfo = document.createElement("DIV");         				//回答数据的显示
         divInfo.className = "info";
         divInfo.id = "INFO_"+chatID;							//数据接收后，通过chatID实现数据精准显示
         divChat.appendChild(divInfo);


         var divOperation = document.createElement("DIV");         			//回答数据的操作
         divOperation.className = "operation";

         var btnRemove = document.createElement("input");				//删除记录按钮
         btnRemove.id = "BTN_REMOVE_" + chatID;
         btnRemove.className = "remove";
         btnRemove.title = "此操作可以丢弃已接收的返回数据和相关联的提问数据，使两者不会对整个会话产生影响。";
         btnRemove.onclick = function(){						//从历史记录里删除此问答数据
            if(arrAbortController[nChatID]) 	delete arrAbortController[nChatID];	//删除终止控制器
            if(arrChatMessages[nChatID-1])      delete arrChatMessages[nChatID-1];	//删除询问的历史纪录
            if(arrChatMessages[nChatID])        delete arrChatMessages[nChatID];	//删除回答的历史纪录
            btnRemove.value = "已删除此轮对话记录";
            divChat.style.background = 'black';
         };
         btnRemove.value = "删除此轮对话";
         btnRemove.type = "button";
         divOperation.appendChild(btnRemove);

         var btnRemoveReply = document.createElement("input");				//删除记录按钮
         btnRemoveReply.id = "BTN_REMOVE_REPLY_" + chatID;
         btnRemoveReply.className = "remove_reply";
         btnRemoveReply.title = "此操作可以丢弃已接收的返回数据，使其不会对整个会话产生影响，同时，询问将保留。";
         btnRemoveReply.onclick = function(){						//从历史记录里删除此问答数据
            if(arrAbortController[nChatID]) 	delete arrAbortController[nChatID];	//删除终止控制器
            //if(arrChatMessages[nChatID-1])    delete arrChatMessages[nChatID-1];	//删除询问的历史纪录
            if(arrChatMessages[nChatID])        delete arrChatMessages[nChatID];	//删除回答的历史纪录
            btnRemoveReply.value = "已删除此条回答记录";
            divReply.style.background = 'black';
         };
         btnRemoveReply.value = "删除此条回答";
         btnRemoveReply.type = "button";
         divOperation.appendChild(btnRemoveReply);

         var btnAbort = document.createElement("input");				//终止接收按钮
         btnAbort.id = "BTN_ABORT_" + chatID;
         btnAbort.className = "abort";
         btnAbort.title = "如数据还没有接收完毕，可以用此按钮直接终止接收，部分已接收数据直接被丢弃，不会对整个会话产生影响。";
         btnAbort.onclick = function(){							//终止接收操作
            arrAbortController[nChatID].abort();					//执行终止fetch操作
            if(arrAbortController[nChatID]) 	delete arrAbortController[nChatID];	//删除终止控制器
            //if(arrChatMessages[nChatID-1])    delete arrChatMessages[nChatID-1];	//删除询问的历史纪录
            if(arrChatMessages[nChatID])        delete arrChatMessages[nChatID];	//删除回答的历史纪录
            btnAbort.value = "已终止接收并删除此条回答记录";
            btnRemove.style.display="block";
            divReply.style.background = 'black';
         };
         btnAbort.value = "终止接收并删除此条回答";
         btnAbort.type = "button";
         divOperation.appendChild(btnAbort);
         divChat.appendChild(divOperation);

         divMsg.appendChild(divChat);

         arrChatDivs[chatID] = divText;							//保存显示返回值的窗口句柄
         //arrTokenCounter[chatID] = 0;							//Token计数器
         arrChatResponse[chatID] =  "";							//接收数据缓存初始化
         arrChatMessages[chatID-1] = new Array(dsRole.value,msgInput.value);		//询问数据存数组
         arrChatMessages[chatID] = new Array('','');					//给回答占位，通过chatID实现数据精准保存

         buildMsg();									//构建历史会话内容，需要将所有往来数据都打包（不包括“<think>...</think>”的数据）
         fetchDataAndProcess(chatID);							//发送请求并对返回数据进行处理
      }
   }

   //构建请求数据
   function buildMsg(){
      jsonData.model = dsModel.value;
      jsonData.options.temperature = parseFloat(dsTemperature.value);
      var arrMsg = Object.values(arrChatMessages);

      var nMsgCounter = 0;
      for(i=0;i<arrMsg.length;i++){
         if(arrMsg[i][0] != '')
         {
            jsonData.messages[nMsgCounter++] = {
               "role": arrMsg[i][0],
               "content": arrMsg[i][1]
            };
         }
      }
   }

   //向接口/api/chat发出会话请求
   async  function fetchDataAndProcess(currentChatID) {
      try{
         const response = await fetch('http://'+dsServer.value+':11434'+dsChatAPI, {
            signal:  arrAbortController[currentChatID].signal,
            method:  'POST',
            headers: headers,
            cache:   'no-store',
            body:    JSON.stringify(jsonData)
         });
         const reader = response.body.getReader();
         while (true) {
             const { done, value } = await reader.read();				//读流数据
             if (done) { break; } 							//读取完成
             const chunk = new TextDecoder().decode(value);             		//处理每块数据，例如将其转换为字符串
             processData(chunk, currentChatID); 					//处理数据
         }
      }catch(error)									//AbortController在执行abort()后，会产生error。
      {
         //console.logs("取消获取了。");
      } 
   }

   //解析数据
   function processData(data, currentChatID) {
      var jsonData = null;
      try{
         jsonData = JSON.parse(data);
      }catch(e){
         //console.log(e);
      }

      if(jsonData!=null && JSON.stringify(jsonData)!="{}"){
         //arrTokenCounter[currentChatID]++;						//Token计数器
         arrChatResponse[currentChatID] += jsonData.message.content;			//拼接返回的数据文本
         arrChatDivs[currentChatID].innerText += jsonData.message.content;		//向指定窗口输出返回的数据文本
         if(jsonData.done == true){							//接收完毕

            var dateStr=jsonData.created_at;
            var d=new Date(dateStr);
            document.getElementById('INFO_'+currentChatID).innerText='【本次解答，创建于 '+ d.toLocaleString() +'，使用模型为' +jsonData.model+ '，模型在评估（evaluation）过程中执行的推理步骤或计算次数为 '+ jsonData.eval_count +' 个tokens，耗时 '+(jsonData.eval_duration/100000000)+' ms，模型在处理输入提示（prompt）时，实际执行的推理步骤或计算次数为：'+ jsonData.prompt_eval_count +' 个tokens，耗时为 '+(jsonData.prompt_eval_duration/100000000)+' ms，总耗时为 '+(jsonData.total_duration/100000000)+' ms。】';

            document.getElementById('BTN_ABORT_'+currentChatID).style.display = "none";		//隐藏终止接收按钮
            document.getElementById('BTN_REMOVE_'+currentChatID).style.display = "block";	//显示删除此轮会话按钮
            document.getElementById('BTN_REMOVE_REPLY_'+currentChatID).style.display = "block";	//显示删除此条按钮

            var arrThinking = arrChatResponse[currentChatID].split("</think>");		//将返回的数据文本中的“<think>...</think>”删除
            if(arrThinking.length==2)
            {
               arrChatMessages[currentChatID] = new Array("assistant",arrThinking[1].trim("\n\n"));//将去除了“<think>...</think>”后的数据存入消息队列
            }
            delete arrChatResponse[currentChatID];					//清除保存的返回数据
            //delete arrTokenCounter[currentChatID];					//清除Token计数器
            delete arrAbortController[currentChatID];					//清除终止控制器

            //o.innerText += "\r\n用时："+jsonData.total_duration+"\r\n";
         }
         //divMsg.scrollTo(0, divMsg.scrollHeight);					//保持聊天窗口始终在底部
      }
   }
  </script>

  </head>
  <body>
    <div id="root">
      <div style="height:700px;display: flex;flex-direction: column;">
        <!--对话消息显示界面-->
        <div id=msgText style="position: relative;height:100%;width: 100%;background: lightskyblue;left: 0px;top: 0px;text-align: left;  overflow: scroll;  overflow-x: auto;  overflow-y: auto;  "></div>
        <!--用户输入界面-->
        <div id="query" style="position: relative;height: 150px;width: 100%;background: burlywood;left: 0px;top: 0px;">
          <!--新建会话按钮-->
          <input type=button value="新建会话" onclick="newChat()" title='清除原有会话信息'>
          <!--选择服务器-->
          <select id=dsserver name=dsserver onchange="getModel(this);" title='已安装DeepSeek的服务器'>
             <option value="">请选择DeepSeek服务器</option>
             <option value="192.168.4.11">服务器1</option>
             <option value="192.168.4.22">服务器2</option>
             <option value="192.168.4.23">服务器3</option>
             <option value="192.168.4.34">服务器4</option>
             <option value="192.168.4.35">服务器5</option>
             <option value="192.168.4.46">服务器6</option>
             <option value="192.168.4.47">服务器7</option>
             <option value="192.168.4.58">服务器8</option>
             <option value="192.168.4.55">备用一</option>
             <option value="192.168.4.56">备用二</option>
             <option value="127.0.0.1" title="仅部分已安装服务的机器可用。">本机</option>
          </select>
          <!--选择模型-->
          <select id=dsmodel name=dsmodel title='模型版本'></select>
          <!--设置角色-->
          <select id=dsrole name=dsrole title='会话设定'>
             <option value=system>设置对话的背景或上下文</option>
             <option value=user>向助手提出的问题或请求</user>
          </select>
          <!--设置温度（复杂度？）-->
          <select id=dstemperature name=dstemperature title='随机性或多样性参数（0为确定和保守，数字越高越有多样性，富有创意）。'>
             <option value="0.0">代码生成/数学解题</option>
             <option value="1.0">数据抽取/分析</option>
             <option value="1.3">通用对话</option>
             <option value="1.3">翻译</option>
             <option value="1.5">创意类写作/诗歌创作</option>
          </select>
          <!--请求信息-->
          <textarea type=text id=queryText name=queryText style="width: 100%; height: 100px;"></textarea>
          <input type=button onclick="sendQuery();" value="提交"></div>
      </div>
    </div>
    <script>
      divMsg        = document.getElementById('msgText');	//用于保持始终在页面底部的操作
      msgInput      = document.getElementById('queryText');	//用户输入
      modelSelector = document.getElementById("dsmodel");	//模型选择
      dsServer	    = document.getElementById("dsserver");	//DeepSeek服务器地址
      dsModel	    = document.getElementById("dsmodel");	//DeepSeek模型
      dsRole	    = document.getElementById("dsrole");	//DeepSeek角色
      dsTemperature = document.getElementById("dstemperature"); //随机和多样性参数
    </script>
  </body>

</html>
